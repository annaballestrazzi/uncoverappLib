## An interactive graphical web application for clinical assessment of sequence coverage at base-pair level

This is a web application for clinical assessment of sequence coverage. 
uncoverApp allows:

- to display interactive plots showing sequence gene coverage down to base-pair
resolution and functional/clinical annotations of sequence 
positions within coverage gaps (`Coverage Analysis` page).

- to calculate the [maximum credible population allele frequency](http://cardiodb.org/allelefrequencyapp/) (AF) to be applied as AF 
filtering threshold tailored to the model of the disease-of-interest 
instead of a general AF cut-off (e.g. 1% or 0.1%) 
(`Calculate AF by allele frequency app` page).

- to calculate the 95% probability of the binomial distribution to observe at 
least N variant-supporting reads (N is the number of successes) based on a 
user-defined allele fraction that is expected for the variant 
(which is the probability of success). Especially useful to obtain the 
range of variant-supporting reads that is most likely to occur at a given 
depth of coverage (DoC) (which is the number of trials) for somatic variants
with low allele fraction
(`Binomial distribution` page). 

---

## Documentation 

All uncoverApp functionalities are based on the availability of a bed file 
containing tab-separated specification of genomic coordinates (chromosome, 
start position, end position), coverage value and reference:alternate 
allele counts read for each position.

### Input Files

In the **Processing and Statistical Summary** page, users prepare the bed file providing 
input files containing a list of genes and a list of BAM or BED coverage files, respectively: 

#### Gene List File

A text file, with `.txt` extension, containing HGNC official gene name(s) one per 
row and to be uploaded to `Load input filtering file` box. An example file is
included in extdata of uncoverappLib package. 

Users can also use a **target BED file** with 4 columns: chromosome, start, end and gene/amplicon name.

**Example gene list:**
```
DNAJC8
GNB1
PEX10
RPL22
```

#### BAM/BED File List

A text file, with `.list` extension, containing absolute paths to BAM or BED coverage files
(one per row) and to be uploaded to `Load your genomic data` box.

In the output file, sample 1, 2, 3... correspond to the samples in the list file in row 1, 2, 3...

**Example BAM list (Unix/macOS):**
```
/home/user/bam/sample1.bam
/home/user/bam/sample2.bam
/home/user/bam/sample3.bam
```

**Example BED coverage list:**
```
/home/user/coverage/sample1_coverage.bed
/home/user/coverage/sample2_coverage.bed
/home/user/coverage/sample3_coverage.bed
```

#### Coordinate Systems

**Important:** Specify the correct coordinate system for your input files.

- **0-based (BED standard)**: Start position is 0-indexed (chr1:100-200 means bases 101-200)
  - Used by: bedtools, mosdepth, most BED files
  - **This is the default and recommended option**

- **1-based (IGV, VCF)**: Start position is 1-indexed (chr1:100-200 means bases 100-200)
  - Used by: IGV, VCF files, samtools depth output

**When in doubt:** Use 0-based for BED files generated by bedtools or mosdepth.

While all inputs are loading, a progress bar appears during processing phase. 
uncoverApp input file generation fails if incorrect gene names are specified. 
An unrecognized gene name(s) table is displayed if such a case occurs.

### Output Format

**Example output BED file from Preprocessing:**
```
chr15   89859516        89859516        68
chr15   89859517        89859517        70
chr15   89859518        89859518        73
chr15   89859519        89859519        73
chr15   89859520        89859520        74
chr15   89859521        89859521        75
```

Format: chromosome, start (1-based), end, coverage_depth

### Processing Time

The preprocessing time depends on the size of the BAM file(s) and on the number 
of genes to investigate. 

**For large analyses (>50 genes or >10 samples)**, we recommend using the `buildInput()` function 
in R console before launching the app, or using the batch mode (see below).

### Alternative Tools

Alternatively, other tools can generate compatible input files:
- [bedtools](https://bedtools.readthedocs.io/en/latest/#) - genomecov
- [mosdepth](https://github.com/brentp/mosdepth) - fast coverage calculator
- [samtools depth](http://www.htslib.org/doc/samtools-depth.html)
- [GATK DepthOfCoverage](https://gatk.broadinstitute.org/hc/en-us)

In this case, users can load the file directly on the **Coverage Analysis** page 
in `Select input file` box.

---

## Coverage Analysis

Once the bed file is ready, users can move to **Coverage Analysis** page and click 
`load input file` button.

### Input Parameters

To assess sequence coverage, the following **input parameters** must be 
specified in the sidebar:

- **Reference Genome**: hg19 or hg38
- **Coverage threshold**: Required minimum coverage depth (default: 20x)
  - Positions with coverage ≤ threshold will be flagged as "low coverage"
- **Sample**: Sample name to analyze (matches column name in coverage file)
  - Example: `sample1` for column `count_sample1` in BED file

### Filtering Options

**Filter by:**

- **Gene name**: Enter HGNC official gene symbol (e.g., BRCA1, TP53)
  - Click **"Lookup UCSC Gene"** button to load gene coordinates
  - Then click **"Calculate Low Coverage Regions"**
  - **Required for maxAF analysis** (see below)

- **Chromosome**: Select specific chromosome (chr1-chr22, chrX, chrY, chrM)
  - Analyzes all genes on selected chromosome

- **All chromosomes**: Analyze entire genome
  - WARNING: This can be slow for large files

- **Region coordinates**: Specify genomic region 
  - Format: `chr7:37453745-45627643` or `7:37453745-45627643`
  - Useful for zooming into specific loci

### Action Buttons

- **Calculate Low Coverage Regions**: Filters positions by coverage threshold
  - Must be clicked BEFORE annotation
  - Results appear in "Low-coverage positions" tab

- **Calculate Annotations**: Queries dbNSFP database for variant annotations
  - Requires low coverage calculation first
  - Results appear in "Annotations on low-coverage positions" tab
  - Can take 1-5 minutes depending on number of positions

### Outputs

uncoverApp generates the following **outputs**:

- **bed file**: Unfiltered BED file (uploaded data)

- **Low coverage positions**: Filtered dataset showing positions below threshold

- **UCSC gene**: Gene coordinates table (if "Filter by: Gene name" used)

- **Gene coverage**: Interactive plot displaying:
  - Chromosome ideogram
  - Genomic location
  - Gene annotations from *Ensembl*
  - Transcripts annotation from *UCSC*
  - Coverage histogram (red = low, blue = high)

- **Zoom to sequence**: Detailed view of specific genomic intervals
  - Enter START and END positions in sidebar
  - Useful for examining individual exons

- **Annotations on low-coverage positions**: dbNSFP annotation table
  - Click **"Calculate Annotations"** button to retrieve annotations
  - Click **"Download Annotations"** button to save as formatted Excel file
  - Cells are colored according to pre-specified thresholds:
    - **Red**: Pathogenic predictions, ClinVar entries, rare variants (AF < 0.5)
    - **Green**: Benign predictions, common variants (AF > 0.5)
    - **Yellow**: High-impact variants (MutationAssessor H/M + ClinVar + rare)

---

## Calculate Maximum Credible Allele Frequency

In the **Calculate AF by allele frequency app** page, users can set 
allele frequency cut-offs based on specific assumptions about the genetic 
architecture of the disease.

### Important: Gene-Specific Analysis Required

**This analysis ONLY works with gene-specific filtering.**

**Before using the maxAF tab:**

1. Go to **"Coverage Analysis"** page
2. Select **"Filter by: Gene name"**
3. Enter your gene of interest (e.g., BRCA1)
4. Click **"Lookup UCSC Gene"** button
5. Click **"Calculate Low Coverage Regions"**
6. Click **"Calculate Annotations"**
7. Switch to **"Calculate AF by allele frequency app"** tab

**Why?** maxAF calculations are gene-specific and disease-specific. Using "All chromosomes" 
or "Chromosome" filters will show ALL variants genome-wide, which is not meaningful for 
maxAF filtering (you would be applying the same threshold to all genes regardless of their 
role in disease).

### Parameters

Users can adjust the following parameters:

- **Prevalence**: Disease prevalence (1 in X people)
  - Example: 1 in 500 for hypertrophic cardiomyopathy

- **Inheritance**: Monoallelic (dominant) or biallelic (recessive)

- **Allelic heterogeneity**: Proportion of cases due to variants in THIS gene
  - Example: 0.5 = 50% of cases are due to this gene

- **Genetic heterogeneity**: Proportion of cases due to genetic factors (vs environmental)
  - Example: 1.0 = 100% genetic

- **Penetrance**: Probability that carriers develop disease
  - Example: 0.5 = 50% of carriers affected

The app calculates the **maximum credible allele frequency** and filters variants 
with AF below this threshold.

### Output

Users may click on the **"Download_maxAF"** button and save the resulting table as formatted 
Excel file with variants filtered by maxAF threshold.

---

## Binomial Distribution

The **Binomial distribution** page calculates the 95% binomial probability 
distribution of variant-supporting reads at a specific genomic position.

### Use Case

This tool is especially useful for:
- **Somatic variants** with low allele fraction
- **Mosaic variants** 
- **Subclonal variants** in tumor samples
- Determining **detection probability** at a given coverage depth

### Required Inputs

- **Genomic position**: Position to analyze
  - Enter position from low-coverage positions table
  - Format: single base position (e.g., 41243452)

- **Allele fraction**: Expected fraction of variant reads (probability of success)
  - Example: 0.5 for germline heterozygous
  - Example: 0.05 for low-frequency somatic variant

- **Variant reads**: Minimum number of variant reads required to support variant calling
  - Your quality threshold (e.g., 10 reads minimum)

### Outputs

The tool provides:

- **Binomial Distribution plot**: Shows probability of observing X variant reads
  - Bars colored by whether they meet your threshold

- **Cumulative distribution function**: P(X ≤ x) plot

- **95% confidence interval**: Expected range of variant reads

- **Interpretation**: Text explanation of whether your threshold is appropriate
  - Green: Threshold is reasonable (within 95% CI)
  - Red: Threshold too high/low (outside 95% CI)

**Example interpretation:**

> "At 100x coverage with expected AF=0.05, you expect 5 variant reads. 
> Your threshold of 10 reads is ABOVE the 95% CI [2, 9], meaning you may 
> be MISSING true variants with this stringent threshold."

---

## Batch Mode (Command-Line)

For automated pipelines and processing multiple samples, uncoverAppLib can be used 
from the command line with the following functions:

### Generate Coverage Data
```r
library(uncoverappLib)

# Process BAM files
buildInput(
  geneList = "genes.txt",              # Gene list or BED file
  sampleList = "samples.list",         # List of BAM/BED files
  genome = "hg38",                     # hg19 or hg38
  chromosome_notation = "chr",         # "chr" or "number"
  type_input = "genes",                # "genes" or "target"
  type_coverage = "bam",               # "bam" or "bed"
  outDir = "./output",
  MAPQ.min = 20,                       # Minimum mapping quality (BAM only)
  base.quality = 20                    # Minimum base quality (BAM only)
)

# Process BED coverage files (faster!)
buildInput(
  geneList = "genes.txt",
  sampleList = "coverage.list",        # List of BED coverage files
  genome = "hg38",
  chromosome_notation = "chr",
  type_input = "genes",
  type_coverage = "bed",               # BED coverage files
  input_coord_system = "0-based",      # Specify coordinate system
  outDir = "./output"
)

# Output:
# - output/output/DATE.bed (coverage data)
# - output/output/DATE_statistical_summary.txt
```

### Annotate Low-Coverage Positions
```r
# Annotate positions below coverage threshold
buildAnnotation(
  sample_data = "output/output/Mon_Nov_25_2024.bed",
  target_sample = "sample1",           # Sample name (without "count_" prefix)
  coverage_threshold = 20,
  genome = "hg38",
  output_intersect = "sample1_lowcov.tsv",
  output_formatted = "sample1_lowcov.xlsx"
)

# Output:
# - sample1_lowcov.tsv (tab-separated data)
# - sample1_lowcov.xlsx (formatted Excel with conditional coloring)
```

### Batch Processing Multiple Samples
```r
# Process cohort
samples <- c("patient001", "patient002", "patient003")
coverage_file <- "output/output/Mon_Nov_25_2024.bed"

for (sample in samples) {
  cat("Processing:", sample, "\n")
  
  buildAnnotation(
    sample_data = coverage_file,
    target_sample = sample,
    coverage_threshold = 20,
    genome = "hg38",
    output_formatted = paste0("results/", sample, "_annotated.xlsx")
  )
}

cat("Cohort processing complete!\n")
```

### Documentation

For detailed batch processing examples and tutorials, see the package vignette:
```r
# View vignette
vignette("batch-processing", package = "uncoverappLib")

# Or after installation
browseVignettes("uncoverappLib")
```

---

## Installation

### From GitHub (Recommended)
```r
# Install dependencies
install.packages("devtools")

# Install uncoverappLib
devtools::install_github("annaballestrazzi/uncoverappLib", 
                         build_vignettes = TRUE)
```

### Setup Annotation Files

**First-time setup (one-time only):**
```r
library(uncoverappLib)

# Download annotation files (~1GB, takes 10-20 minutes)
setup_uncoverapp()

# Verify files are ready
check_annotations()
```

### Launch App
```r
# Launch in browser (recommended)
run.uncoverapp()

# Or specify launch location
run.uncoverapp(where = "browser")  # Default browser
run.uncoverapp(where = "viewer")   # RStudio viewer pane
run.uncoverapp(where = "window")   # RStudio window
```

---

## Links and Resources

- **GitHub Repository:** https://github.com/annaballestrazzi/uncoverAppLib
- **Issues/Support:** https://github.com/annaballestrazzi/uncoverAppLib/issues
- **BioRxiv Paper:** https://www.biorxiv.org/content/10.1101/2020.02.10.939769v1
- **Zenodo (Annotation Files):** https://zenodo.org/records/17524340
- **maxAF Calculator:** http://cardiodb.org/allelefrequencyapp/

---

## Citation

If you use uncoverAppLib in your research, please cite:

Iovino E, Pippucci T, et al. (2020). uncoverApp: a web application for clinical 
assessment and annotation of coverage gaps in target genes. *bioRxiv*. 
doi: 10.1101/2020.02.10.939769

---

## Troubleshooting

### Common Issues

**"Gene not found"**
- Use official HGNC gene symbols (e.g., TP53, not p53)
- Check genome version matches your data (hg19 vs hg38)

**"No coverage data"**
- Verify BAM/BED chromosome naming matches ("chr1" vs "1")
- Check coordinate system (0-based vs 1-based)
- Ensure coverage file has correct format

**"Cannot open file"**
- Use absolute paths in `.list` files
- Check file permissions

**"maxAF tab shows no results"**
- You must use "Filter by: Gene name" (see maxAF section above)
- Click "Calculate Annotations" before switching to maxAF tab

**"App is slow"**
- For large analyses (>50 genes), use batch mode instead
- Use BED coverage files instead of BAM files (10-50x faster)
- Process samples in parallel using `mclapply()`

---

**Version:** 1.10.0  
**Last updated:** November 2024